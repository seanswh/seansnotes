(1)shader 代码分析
看一下下面的fragment shader代码
首先看计算光照的算法，输入参数分别是：反射光线方向、光线颜色、法线方向、半角方向，材质漫射参数，镜面参数
![](/Computer_Graphics/images/38.png)
首先计算漫反射，根据Lambert计算公式求得lambert光照结果，然后根据Blinn-Phong公式计算镜面反射光照。最后把漫反射和镜面反射光照求和。这里面注意，direction指的是离开物体的反射光方向，halfvec也是离开物体的半角方向，因此retval也是离开物体的方向。
下面再看一下main函数：
![](/Computer_Graphics/images/39.PNG)
首先检查一下该片元上是否有纹理，如果有，那颜色就通过texture函数获得；如果没有，看就看是否有光照，如果没有，那么片元的颜色就是物体本身的颜色，如果有外部光源，需要进行颜色计算。
首先，眼睛所在的位置是(0,0,0),朝向-z方向，然后将顶点位置去齐次化。随后定义视线向量，同时将它标准化，得到单位向量。然后我们得到单位法线向量，这个单位法线向量是从vertex shader传输过来。
![](/Computer_Graphics/images/40.png)
接下来处理光源，light0是平行光源，获取半角方向其实就是简单的把两个向量求和然后标准化就行（向量和就是平行四边形的对角线方向，正好是半角方向），然后调用前面讲的光照函数；light1是点光源，首先先去齐次化，然后让光源位置减顶点位置得到光线方向，然后得到点光源与视线的半角方向，并标准化
最后，光源的位置需要先通过modelview矩阵进行调整。光源的移动类型：（1）静态，每次都乘以单位矩阵；（2）移动，先将矩阵压栈，然后移动光源，然后弹出