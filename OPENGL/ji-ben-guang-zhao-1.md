### 光照基础

现实世界的光照是极其复杂的，而且会受到诸多因素的影响，这是以目前我们所拥有的计算能力无法模拟的。因此OpenGL的光照仅仅使用了简化的模型并基于对现实的估计来进行模拟，这样处理起来会更容易一些，而且看起来也差不多一样。其中一个模型被称为冯氏光照模型\(Phong Lighting Model\)。冯氏光照模型的主要结构由3个元素组成：环境\(Ambient\)、漫反射\(Diffuse\)和镜面\(Specular\)光照。这些光照元素看起来像下面这样：![](/OPENGL/images/basic_lighting_phong.png)

环境光照\(Ambient Lighting\)：即使在黑暗的情况下，世界上也仍然有一些光亮\(月亮、一个来自远处的光\)，所以物体永远不会是完全黑暗的。我们使用环境光照来模拟这种情况，也就是无论如何永远都给物体一些颜色。

漫反射光照\(Diffuse Lighting\)：模拟一个发光物对物体的方向性影响\(Directional Impact\)。它是冯氏光照模型最显著的组成部分。面向光源的一面比其他面会更亮。

镜面光照\(Specular Lighting\)：模拟光滑物体上面出现的亮点。镜面光照的颜色，相比于物体的颜色更倾向于光的颜色。

### 环境光照\(ambient\)

光通常都不是来自于同一光源，而是来自散落于我们周围的很多光源.它可以向很多方向发散和反弹，所以光最后到达的地点可能并不是它所临近的直射方向；光能够像这样**反射\(Reflect\)**到其他表面，一个物体的光照可能受到来自一个非直射的光源影响。考虑到这种情况的算法叫做**全局照明\(Global Illumination\)**算法，但是这种算法既开销高昂又极其复杂。

我们可以使用一种简化的且开销极低的方式来计算全局照明模型，该模型称为环境光照模型。

将环境光照加入到OPENGL场景中极为简单，我们用光的颜色乘以一个系数常量，再乘以物体自身的颜色即可作为该片元的颜色了：

```
void main()
{ 
    float ambientStrength = 0.1f;
    vec3 ambient = ambientStrength * lightColor;
    vec3 result = ambient * objectColor;
    color = vec4(result, 1.0f);
}
```

### 漫反射\(diffuse\)

环境光不会产生太多的光源，漫反射则会提供明显的视觉影响。片元距离光源发出的光线越近，物体的亮度就越大。如下图所示：

![](/OPENGL/images/diffuse_light.png)

左上方有一个光源，光源发射的光线落在某一个片元上，我们需要测量光线和它接触到的片元间的角度。如果光线垂直于片元，则光照亮度最大。

计算漫反射角度需要：1）法向量\(上图黄色向量\)；2。光线向量（光源与片元位置之差）

#### 法向量\(Normal Vector\)

每一个顶点都会有一个法向量，其只是指明了方向，但有一个问题，就是在片元着色器计算漫反射光照强度时，光线使用的是世界坐标，因此也需要将法线转化成世界坐标。

但是这不是简单地把它乘以一个模型矩阵就能搞定的。首先，法向量只是一个方向向量，不能表达空间中的特定位置。同时，法向量没有齐次坐标\(顶点位置中的w分量\)。这意味着，平移不应该影响到法向量。因此，如果我们可以把法向量乘以模型矩阵左上角的3×3矩阵\(我们也可以把法向量的w分量设置为0，再乘以4×4矩阵；同样可以移除平移\)。对于法向量，我们只能对它应用缩放\(Scale\)和旋转\(Rotation\)变换。其次，如果模型矩阵执行了不等比缩放，法向量就有可能不再垂直于表面。

因此，我们需要使用线性代数中的一个特殊矩阵\(normal matrix\)进行处理，正规矩阵被定义为“模型矩阵左上角的逆矩阵的转置矩阵”。在顶点着色器中，我们可以使用`inverse`和`transpose`函数自己生成正规矩阵，`inverse`和`transpose`函数对所有类型矩阵都有效。注意，我们也要把这个被处理过的矩阵强制转换为3×3矩阵，这是为了保证不会进行平移，之后它才能乘以法向量。

```
Normal = mat3(transpose(inverse(model))) * normal;
```

> `对于着色器来说，逆矩阵也是一种开销比较大的操作，因此，无论何时，在着色器中只要可能就应该尽量避免逆操作，因为它们必须为你场景中的每个顶点进行这样的处理。对于一个对于效率有要求的应用来说，在绘制之前，你最好用CPU计算出normal matrix(因为模型矩阵不会发生改变)，然后通过uniform把值传递给着色器(和模型矩阵一样)。`



